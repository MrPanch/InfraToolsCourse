# Ansible homework

### Немного комментариев по решению

С помощью `ansible-galaxy` была сформирована роль `nginx` (уже встроенная в ansible), которая лежит в `/roles/nginx`.

В `ansible.cfg` `host_key_checking = False` указана настройка для того, чтобы таски не падали из-за запроса на добавление сервера в `known_hosts`. Также дополнительно указана опция `deprecation_warnings = False`, чтобы при запусках не выводились сообщения о deprecations и других не значимых warnings.

Для реализации условия _идемпотентности_ в сценарии playbook происходит следующее:

1. Файл исходный файл service_state копируется во временную директорию `/tmp/files`
2. Если это привело к состоянию: `=> changed` (а оно приводит к такому состанию, если у исходного файла поменять содержимое), то срабатывает handler, который перезапускает nginx-север и подменяет файл `service_state` в `/opt` (возможно это костыльно, но как сделать лучше я не придумал)

### Как запустить и проверить что работает

Для локальной проверки должен быть установлен `Vagrant` (но это опционально, если есть сервера с доступом по ssh и python, то можно использовать их) и соответсвенно `ansible`.

1. Поднимаем локально ВМ через Vagrant. На данный момент в конфиге `Vagrantfile` прописаны 2 машины с разными ОС, но в целом можно добавить еще каких-то, если не страшно что он съест много локальных ресурсов.

    ```shell
    [IS_HOME=true] vagrant up
    ```

    При запуске выведутся ip-адреса запущенных машин. Их следует записать в inventory-файл `hosts`.
    Проверить какие машины запущены на данный момент можно командой:

    ```shell
    vagrant global-status
    ```

2. После поднятия машин и занесения их ip-шников стоит проверить, что к ним можно подключиться по ssh:

    ```shell
    ssh vagrant@<ip>
    ```

    Если подключение прошло успешно, то можно запускать playbooks ansible.

    Также можно проверить, что ansible можно пинговать машины командой:

    ```shell
    ansible all -i hosts -m ping
    ```

3. Запуск playbook осуществялется след образом:

    ```shell
    ansible-playbook -i hosts web-nginx.yml
    ```

4. После того как все успешно отработало, можно проверять работспособность серверов:

    ```shell
    curl <ip>/service_state
    ```

Далее можно перезапускать сценарии и следить за тем, что ничего не перезатирается. Рестарт сервера происходит в том и только том случае, если поменялся файл `/roles/nginx/files/service_state`.
